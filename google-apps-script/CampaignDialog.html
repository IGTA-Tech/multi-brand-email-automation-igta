<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .form-group {
        margin-bottom: 20px;
      }
      label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
        color: #333;
      }
      select, input[type="text"], input[type="datetime-local"], textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
      }
      textarea {
        min-height: 100px;
        resize: vertical;
      }
      .radio-group {
        display: flex;
        gap: 20px;
        margin-top: 10px;
      }
      .radio-group label {
        display: flex;
        align-items: center;
        font-weight: normal;
      }
      .radio-group input[type="radio"] {
        margin-right: 5px;
        width: auto;
      }
      button {
        background-color: #4285f4;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
      }
      button:hover {
        background-color: #357ae8;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .success {
        color: #0f9d58;
        padding: 10px;
        background-color: #e6f4ea;
        border-radius: 4px;
        margin-bottom: 10px;
        display: none;
      }
      .error {
        color: #d93025;
        padding: 10px;
        background-color: #fce8e6;
        border-radius: 4px;
        margin-bottom: 10px;
        display: none;
      }
      .loading {
        text-align: center;
        padding: 20px;
        display: none;
      }
      .contact-list {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
      }
      .contact-item {
        padding: 5px;
        cursor: pointer;
        border-radius: 3px;
      }
      .contact-item:hover {
        background-color: #f0f0f0;
      }
      .contact-item input[type="checkbox"] {
        margin-right: 10px;
      }
      #templateSection, #customMessageSection, #scheduleSection {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Create New Campaign</h2>

      <div id="successMessage" class="success"></div>
      <div id="errorMessage" class="error"></div>
      <div id="loadingMessage" class="loading">
        <p>Creating campaign...</p>
      </div>

      <form id="campaignForm">
        <!-- Step 1: Identity -->
        <div class="form-group">
          <label for="brandSelect">Brand *</label>
          <select id="brandSelect" required>
            <option value="">Choose brand...</option>
          </select>
        </div>

        <!-- Step 2: Contacts -->
        <div class="form-group">
          <label>Lead Status Filter</label>
          <select id="leadStatusFilter">
            <option value="">All Contacts</option>
            <option value="Hot Lead">Hot Leads Only</option>
            <option value="Warm Lead">Warm Leads Only</option>
            <option value="Cold Lead">Cold Leads Only</option>
          </select>
        </div>

        <div class="form-group">
          <label>Select Contacts * (Hold Ctrl/Cmd to select multiple)</label>
          <div id="contactList" class="contact-list">
            <p>Loading contacts...</p>
          </div>
          <p style="font-size: 12px; color: #666; margin-top: 5px;">
            <span id="selectedCount">0</span> contact(s) selected
          </p>
        </div>

        <!-- Step 3: Message -->
        <div class="form-group">
          <label>Message Type *</label>
          <div class="radio-group">
            <label>
              <input type="radio" name="messageMode" value="template" checked>
              Use Template
            </label>
            <label>
              <input type="radio" name="messageMode" value="manual">
              Write Manually
            </label>
            <label>
              <input type="radio" name="messageMode" value="claude">
              Generate with Claude AI
            </label>
          </div>
        </div>

        <div id="templateSection" class="form-group">
          <label for="templateSelect">Template</label>
          <select id="templateSelect">
            <option value="">Choose template...</option>
          </select>
        </div>

        <div id="customMessageSection">
          <div class="form-group">
            <label for="customSubject">Subject Line</label>
            <input type="text" id="customSubject" placeholder="Enter subject line...">
          </div>
          <div class="form-group">
            <label for="customBody">Message Body</label>
            <textarea id="customBody" placeholder="Enter message body..."></textarea>
          </div>
        </div>

        <!-- Step 4: Delivery -->
        <div class="form-group">
          <label>Delivery Mode *</label>
          <div class="radio-group">
            <label>
              <input type="radio" name="deliveryMode" value="sendNow" checked>
              Send Now
            </label>
            <label>
              <input type="radio" name="deliveryMode" value="scheduled">
              Schedule
            </label>
          </div>
        </div>

        <div id="scheduleSection" class="form-group">
          <label for="scheduledFor">Scheduled Date & Time</label>
          <input type="datetime-local" id="scheduledFor">
        </div>

        <!-- Campaign Name -->
        <div class="form-group">
          <label for="campaignName">Campaign Name *</label>
          <input type="text" id="campaignName" required placeholder="e.g., Q4 Follow-up Campaign">
        </div>

        <button type="submit" id="submitBtn">Create Campaign</button>
      </form>
    </div>

    <script>
      // Load brands on page load
      google.script.run
        .withSuccessHandler(function(brands) {
          const select = document.getElementById('brandSelect');
          brands.forEach(brand => {
            const option = document.createElement('option');
            option.value = brand.id;
            option.textContent = brand.name + ' (' + brand.workspace + ')';
            select.appendChild(option);
          });
        })
        .getBrands();

      // Load contacts
      function loadContacts(leadStatus) {
        const contactList = document.getElementById('contactList');
        contactList.innerHTML = '<p>Loading contacts...</p>';

        google.script.run
          .withSuccessHandler(function(contacts) {
            contactList.innerHTML = '';

            if (contacts.length === 0) {
              contactList.innerHTML = '<p>No contacts found</p>';
              return;
            }

            contacts.forEach(contact => {
              const div = document.createElement('div');
              div.className = 'contact-item';

              const checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.value = contact.id;
              checkbox.onchange = updateSelectedCount;

              const label = document.createElement('span');
              label.textContent = contact.firstName + ' ' + contact.lastName +
                                  ' (' + contact.leadStatus + ', Score: ' + contact.leadScore + ')';

              div.appendChild(checkbox);
              div.appendChild(label);
              div.onclick = function(e) {
                if (e.target !== checkbox) {
                  checkbox.checked = !checkbox.checked;
                  updateSelectedCount();
                }
              };

              contactList.appendChild(div);
            });
          })
          .getContacts(leadStatus);
      }

      // Initial load
      loadContacts(null);

      // Lead status filter change
      document.getElementById('leadStatusFilter').addEventListener('change', function() {
        const leadStatus = this.value || null;
        loadContacts(leadStatus);
      });

      // Brand change - load templates
      document.getElementById('brandSelect').addEventListener('change', function() {
        const brandId = this.value;
        if (!brandId) return;

        google.script.run
          .withSuccessHandler(function(templates) {
            const select = document.getElementById('templateSelect');
            select.innerHTML = '<option value="">Select a template...</option>';

            templates.forEach(template => {
              const option = document.createElement('option');
              option.value = template.id;
              option.textContent = template.name + ' - ' + template.category;
              select.appendChild(option);
            });
          })
          .getTemplates(brandId);
      });

      // Message mode change
      document.querySelectorAll('input[name="messageMode"]').forEach(radio => {
        radio.addEventListener('change', function() {
          const templateSection = document.getElementById('templateSection');
          const customSection = document.getElementById('customMessageSection');

          if (this.value === 'template') {
            templateSection.style.display = 'block';
            customSection.style.display = 'none';
          } else if (this.value === 'manual') {
            templateSection.style.display = 'none';
            customSection.style.display = 'block';
          } else {
            templateSection.style.display = 'none';
            customSection.style.display = 'none';
          }
        });
      });

      // Trigger initial display
      document.querySelector('input[name="messageMode"]:checked').dispatchEvent(new Event('change'));

      // Delivery mode change
      document.querySelectorAll('input[name="deliveryMode"]').forEach(radio => {
        radio.addEventListener('change', function() {
          const scheduleSection = document.getElementById('scheduleSection');
          scheduleSection.style.display = this.value === 'scheduled' ? 'block' : 'none';
        });
      });

      // Update selected count
      function updateSelectedCount() {
        const checkboxes = document.querySelectorAll('#contactList input[type="checkbox"]:checked');
        document.getElementById('selectedCount').textContent = checkboxes.length;
      }

      // Form submission
      document.getElementById('campaignForm').addEventListener('submit', function(e) {
        e.preventDefault();

        // Get selected contacts
        const selectedContacts = [];
        document.querySelectorAll('#contactList input[type="checkbox"]:checked').forEach(cb => {
          selectedContacts.push(cb.value);
        });

        if (selectedContacts.length === 0) {
          showError('Please select at least one contact');
          return;
        }

        // Get form data
        const messageMode = document.querySelector('input[name="messageMode"]:checked').value;
        const deliveryMode = document.querySelector('input[name="deliveryMode"]:checked').value;

        const formData = {
          workspaceId: 'workspace1', // Default
          brandId: document.getElementById('brandSelect').value,
          contactIds: selectedContacts,
          messageMode: messageMode,
          deliveryMode: deliveryMode,
          campaignName: document.getElementById('campaignName').value
        };

        if (messageMode === 'template') {
          formData.templateId = document.getElementById('templateSelect').value;
          if (!formData.templateId) {
            showError('Please select a template');
            return;
          }
        } else if (messageMode === 'manual') {
          formData.customSubject = document.getElementById('customSubject').value;
          formData.customBody = document.getElementById('customBody').value;
          if (!formData.customSubject || !formData.customBody) {
            showError('Please enter subject and body');
            return;
          }
        }

        if (deliveryMode === 'scheduled') {
          formData.scheduledFor = document.getElementById('scheduledFor').value;
          if (!formData.scheduledFor) {
            showError('Please select a scheduled date and time');
            return;
          }
        }

        // Show loading
        document.getElementById('loadingMessage').style.display = 'block';
        document.getElementById('submitBtn').disabled = true;

        // Submit to Apps Script
        google.script.run
          .withSuccessHandler(function(result) {
            document.getElementById('loadingMessage').style.display = 'none';
            showSuccess('Campaign created successfully! ID: ' + result.campaignId);

            // Reset form after 2 seconds
            setTimeout(function() {
              google.script.host.close();
            }, 2000);
          })
          .withFailureHandler(function(error) {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('submitBtn').disabled = false;
            showError('Error: ' + error.message);
          })
          .createCampaignFromDialog(formData);
      });

      function showSuccess(message) {
        const el = document.getElementById('successMessage');
        el.textContent = message;
        el.style.display = 'block';
        document.getElementById('errorMessage').style.display = 'none';
      }

      function showError(message) {
        const el = document.getElementById('errorMessage');
        el.textContent = message;
        el.style.display = 'block';
        document.getElementById('successMessage').style.display = 'none';
      }
    </script>
  </body>
</html>
